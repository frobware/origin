apiVersion: v1
kind: Template
objects:
- apiVersion: v1
  kind: Service
  metadata:
    name: http2
    annotations:
      service.beta.openshift.io/serving-cert-secret-name: serving-cert-http2
  spec:
    selector:
      name: http2
    ports:
      - name: https
        protocol: TCP
        port: 27443
        targetPort: 8443
      - name: http
        protocol: TCP
        port: 8080
        targetPort: 8080
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: src-config
  data:
    data.base64: |
      H4sIAAAAAAAC/+xW32vbOhT2q/VX6AoK9r2+jpzEaWnpw6U0FBq4oQkbg8EQzolrIkupJKd4xf/7
      kOK2Cds6VraWMn8vx+L7zi+do5BcxqVceL8VlFI6Gg2tTQ5Tumu3GFAvGYzSYb8/GlLq0SRJ00MP
      U+8FUGnDlEcpK8ondT/i21Ye7BtBKRcVB5zxShtQCOUSJ3EyQF6HPwK5jHVVvvL7p1+9/xFNuvf/
      EtCgNqDiXL7e/PtJv51/mqTpcODRpD/od/N/EaxZtmI54JIVAqGiXEtlcIB8siwNQT7hMrdGgOld
      G7O231ITFCKUSaGddAFLVnFzMZ9Pp9Ybn2JyRI8o2aNmjrPUcDh4pOaT2Zn1cV49MFnPbmQh8n8z
      UKZnuI4zZfb0l1A/qV9B7QpcViLDXMpVtT4Xm2AFdYTbKO8Yx9qoQuRha/Ed8osl3jAeYbnCx6dY
      6niy6xyeWOIO+b4CUylhtchv0P3xMTRq2uT2UoPQ+mTKjAsONu5jRWQ+mX06u5qTh7q2txEifwX1
      d/SX5x/29JdQhwj5djjxBRMLDuNKZAHpkQjbIoJb7Lgr0GspNLxXhQEVYQU3+O+WualAG1envyxN
      PF6rQphlcBthcqCJ08ZTJY0Mkd98O9s1MG6uP/+apArYoib3yXK5jbnVugXdv5bp/7t3eL+HIfJ9
      LvN4uo1LJoU2IOyopcAuysHmoyCR+7Z57PxBKRvclbh1+E8sZvY3MiDH5B8rjbAoeHjipH+d2oOr
      y+UaM8N4AErZ5A3ym+CZDcye7kBDVing9fNamU9mO920qxnhdud+vj8NHDKD7xrUdP8bO3To0OGN
      4EsAAAD//xkPUGYAEgAA
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: serving-cert-http2
- apiVersion: v1
  kind: Pod
  metadata:
    name: http2
    labels:
      name: http2
  spec:
    containers:
    - image: golang:1.14
      name: server
      command: ["/workdir/http2-server"]
      readinessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 3
        periodSeconds: 3
      env:
      - name: GODEBUG
        value: http2debug=1
      ports:
      - containerPort: 8443
        protocol: TCP
      - containerPort: 8080
        protocol: TCP
      volumeMounts:
      - name: cert
        mountPath: /etc/serving-cert
      - name: workdir
        mountPath: /workdir
      readOnly: true
    initContainers:
    - image: golang:1.14
      name: builder
      command: ["/bin/bash", "-c"]
      args:
        - set -e;
          cd /workdir;
          base64 -d /go/src/data.base64 | tar zxf -;
          go build -v -mod=readonly -o /workdir/http2-server server.go;
      env:
      - name: GO111MODULE
        value: "auto"
      - name: GOCACHE
        value: "/tmp"
      - name: GOPROXY
        value: "https://goproxy.golang.org,direct"
      volumeMounts:
      - name: cert
        mountPath: /etc/serving-cert
      - name: src-volume
        mountPath: /go/src
      - name: workdir
        mountPath: /workdir
    volumes:
    - name: src-volume
      configMap:
        name: src-config
    - name: cert
      secret:
        secretName: serving-cert-http2
    - name: tmp
      emptyDir: {}
    - name: workdir
      emptyDir: {}
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-default-cert-edge
  spec:
    port:
      targetPort: 8080
    tls:
      termination: edge
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-default-cert-reencrypt
  spec:
    port:
      targetPort: 8443
    tls:
      termination: reencrypt
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-default-cert-passthrough
  spec:
    port:
      targetPort: 8443
    tls:
      termination: passthrough
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-custom-cert-edge
  spec:
    port:
      targetPort: 8080
    tls:
      termination: edge
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEIB0ZzacoOqbgxFjpfe4pooxlJo+yatkQXW0unuoq7aDgoAoGCCqGSM49
        AwEHoUQDQgAEsKo/4zO5C/NXugMa6/SvMr70ZsfZWAJLgPR9frE9WG9xqX8BOJS1
        uHdKKSFsDz1AxHCAfzoW2EMfotCY9m8BVQ==
        -----END EC PRIVATE KEY-----
      certificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBfzCCASWgAwIBAgIQOFLbMiDV4jgvLwzexgVq/TAKBggqhkjOPQQDAjAkMRAw
        DgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQDEwdSb290IENBMCAXDTIwMDUwNjEyMjYx
        MFoYDzIxMjAwNDEyMTIyNjEwWjAmMRAwDgYDVQQKEwdSZWQgSGF0MRIwEAYDVQQD
        DAl0ZXN0X2NlcnQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAASwqj/jM7kL81e6
        Axrr9K8yvvRmx9lYAkuA9H1+sT1Yb3GpfwE4lLW4d0opIWwPPUDEcIB/OhbYQx+i
        0Jj2bwFVozUwMzAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEw
        DAYDVR0TAQH/BAIwADAKBggqhkjOPQQDAgNIADBFAiEAh2VBt8DWxCzfk6e+as8k
        KHMFR0AYzPjMcOFQZtDuec0CICp/LQvF7k5r0gbQ2QcRupV1hUuwkZB0v3LFn2kZ
        GuN+
        -----END CERTIFICATE-----
      caCertificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBgTCCASegAwIBAgIRAJ8BWxKJPhjEF1N3ndVw22UwCgYIKoZIzj0EAwIwJDEQ
        MA4GA1UEChMHUmVkIEhhdDEQMA4GA1UEAxMHUm9vdCBDQTAgFw0yMDA1MDYxMjI2
        MTBaGA8yMTIwMDQxMjEyMjYxMFowJDEQMA4GA1UEChMHUmVkIEhhdDEQMA4GA1UE
        AxMHUm9vdCBDQTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABKcGXYHdLn7plsJf
        PsJ1KdTiqkmKVvRpC7VDpl5Q2895j+12MyrZYrpFeXeGM2QeXTNnDOMsfYYfMVmA
        RXp/vf2jODA2MA4GA1UdDwEB/wQEAwICBDATBgNVHSUEDDAKBggrBgEFBQcDATAP
        BgNVHRMBAf8EBTADAQH/MAoGCCqGSM49BAMCA0gAMEUCID1YOnNQ+EWi8ksW6i6T
        GwRxXKphV0MzDQ0z1NXQXTKSAiEAqeCbJdxXYkB4ag3tHDphUkFhXerSRcbb4nzL
        EPf+vmI=
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-custom-cert-reencrypt
  spec:
    port:
      targetPort: 8443
    tls:
      termination: reencrypt
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEICn/M056T7WDLLIlZrlLJYMerPrjl825NLK5m12LYU+BoAoGCCqGSM49
        AwEHoUQDQgAETZgGk3l0HPfIu0WTRX8wqVxR0vgWC6m645mW1sVm6EMIg6AjihLZ
        wdSD+O4eE2HVVtquXNWbqBM0b2hCzLtPkQ==
        -----END EC PRIVATE KEY-----
      certificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBfjCCASWgAwIBAgIQHHruEvoeJpmUPCAUsZFrmDAKBggqhkjOPQQDAjAkMRAw
        DgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQDEwdSb290IENBMCAXDTIwMDUwNjEyMjYx
        MFoYDzIxMjAwNDEyMTIyNjEwWjAmMRAwDgYDVQQKEwdSZWQgSGF0MRIwEAYDVQQD
        DAl0ZXN0X2NlcnQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAARNmAaTeXQc98i7
        RZNFfzCpXFHS+BYLqbrjmZbWxWboQwiDoCOKEtnB1IP47h4TYdVW2q5c1ZuoEzRv
        aELMu0+RozUwMzAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEw
        DAYDVR0TAQH/BAIwADAKBggqhkjOPQQDAgNHADBEAiBs5rAUuV0Kq1lu6At9+l9k
        91IWGyehlnUmpefMF8k/ZQIgHp1ZCBR+X+YRuI9T5zhJLjw7O5zN9/OUVrmL5hVX
        IvI=
        -----END CERTIFICATE-----
      caCertificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBgDCCASagAwIBAgIQBhP8c3vdKDTeWHJCDYNLLjAKBggqhkjOPQQDAjAkMRAw
        DgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQDEwdSb290IENBMCAXDTIwMDUwNjEyMjYx
        MFoYDzIxMjAwNDEyMTIyNjEwWjAkMRAwDgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQD
        EwdSb290IENBMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEQRFGuSS3MOALxNTV
        Ah42fN6TL9SgFTGro6226PpEGr9VQkZsrGB7ihwUR/Tn72MQdBXpMgA+rir1imHG
        qVapA6M4MDYwDgYDVR0PAQH/BAQDAgIEMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8G
        A1UdEwEB/wQFMAMBAf8wCgYIKoZIzj0EAwIDSAAwRQIhAPfGfxNx2RTdV0WAiDgB
        M+aAPrxtJ82ffqbKpxqlAq7oAiBtCvLIDcit3iTVHZWB1wLbYQTvRUG9h7bmqpnY
        Yp9nWg==
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-custom-cert-passthrough
  spec:
    port:
      targetPort: 8443
    tls:
      termination: passthrough
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
