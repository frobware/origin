apiVersion: v1
kind: Template
objects:
- apiVersion: v1
  kind: Service
  metadata:
    name: http2
    annotations:
      service.beta.openshift.io/serving-cert-secret-name: serving-cert-http2
  spec:
    selector:
      name: http2
    ports:
      - name: https
        protocol: TCP
        port: 27443
        targetPort: 8443
      - name: http
        protocol: TCP
        port: 8080
        targetPort: 8080
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: src-config
  data:
    data.base64: |
      H4sIAAAAAAAC/+xW32vbOhT2q/VX6AoK9r2+jpzEaWnpw6U0FBq4oQkbg8EQzolrIkupJKd4xf/7
      kOK2Cds6VraWMn8vx+L7zi+do5BcxqVceL8VlFI6Gg2tTQ5Tumu3GFAvGYzSYb8/GlLq0SRJ00MP
      U+8FUGnDlEcpK8ondT/i21Ye7BtBKRcVB5zxShtQCOUSJ3EyQF6HPwK5jHVVvvL7p1+9/xFNuvf/
      EtCgNqDiXL7e/PtJv51/mqTpcODRpD/od/N/EaxZtmI54JIVAqGiXEtlcIB8siwNQT7hMrdGgOld
      G7O231ITFCKUSaGddAFLVnFzMZ9Pp9Ybn2JyRI8o2aNmjrPUcDh4pOaT2Zn1cV49MFnPbmQh8n8z
      UKZnuI4zZfb0l1A/qV9B7QpcViLDXMpVtT4Xm2AFdYTbKO8Yx9qoQuRha/Ed8osl3jAeYbnCx6dY
      6niy6xyeWOIO+b4CUylhtchv0P3xMTRq2uT2UoPQ+mTKjAsONu5jRWQ+mX06u5qTh7q2txEifwX1
      d/SX5x/29JdQhwj5djjxBRMLDuNKZAHpkQjbIoJb7Lgr0GspNLxXhQEVYQU3+O+WualAG1envyxN
      PF6rQphlcBthcqCJ08ZTJY0Mkd98O9s1MG6uP/+apArYoib3yXK5jbnVugXdv5bp/7t3eL+HIfJ9
      LvN4uo1LJoU2IOyopcAuysHmoyCR+7Z57PxBKRvclbh1+E8sZvY3MiDH5B8rjbAoeHjipH+d2oOr
      y+UaM8N4AErZ5A3ym+CZDcye7kBDVing9fNamU9mO920qxnhdud+vj8NHDKD7xrUdP8bO3To0OGN
      4EsAAAD//xkPUGYAEgAA
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: serving-cert-http2
- apiVersion: v1
  kind: Pod
  metadata:
    name: http2
    labels:
      name: http2
  spec:
    containers:
    - image: golang:1.14
      name: server
      command: ["/workdir/http2-server"]
      readinessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 3
        periodSeconds: 3
      env:
      - name: GODEBUG
        value: http2debug=2
      ports:
      - containerPort: 8443
        protocol: TCP
      - containerPort: 8080
        protocol: TCP
      volumeMounts:
      - name: cert
        mountPath: /etc/serving-cert
      - name: workdir
        mountPath: /workdir
      readOnly: true
    initContainers:
    - image: golang:1.14
      name: builder
      command: ["/bin/bash", "-c"]
      args:
        - set -e;
          cd /workdir;
          base64 -d /go/src/data.base64 | tar zxf -;
          go build -v -mod=readonly -o /workdir/http2-server server.go;
      env:
      - name: GO111MODULE
        value: "auto"
      - name: GOCACHE
        value: "/tmp"
      - name: GOPROXY
        value: "https://goproxy.golang.org,direct"
      volumeMounts:
      - name: cert
        mountPath: /etc/serving-cert
      - name: src-volume
        mountPath: /go/src
      - name: workdir
        mountPath: /workdir
    volumes:
    - name: src-volume
      configMap:
        name: src-config
    - name: cert
      secret:
        secretName: serving-cert-http2
    - name: tmp
      emptyDir: {}
    - name: workdir
      emptyDir: {}
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-default-cert-edge
  spec:
    port:
      targetPort: 8080
    tls:
      termination: edge
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-default-cert-reencrypt
  spec:
    port:
      targetPort: 8443
    tls:
      termination: reencrypt
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-default-cert-passthrough
  spec:
    port:
      targetPort: 8443
    tls:
      termination: passthrough
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-custom-cert-edge
  spec:
    port:
      targetPort: 8080
    tls:
      termination: edge
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEIAup1Jdr6n7Yvj5H7fq2Beg3bh9zd/F4KeVNkGwZXY29oAoGCCqGSM49
        AwEHoUQDQgAEMmUaVefHDJhOLGA/PKqluKpIeKIE0tIz8kEwOhaOM+XRfK1T2Odz
        3xnp3jqVGeL/P76Ablpyt3UjVXqS/2jq7w==
        -----END EC PRIVATE KEY-----
      certificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBgTCCASagAwIBAgIRAI0MkoawZHMRv81Y6XjnBCkwCgYIKoZIzj0EAwIwJDEQ
        MA4GA1UEChMHUmVkIEhhdDEQMA4GA1UEAxMHUm9vdCBDQTAgFw0yMDA1MDYxMTEx
        MzNaGA8yMTIwMDQxMjExMTEzM1owJjEQMA4GA1UEChMHUmVkIEhhdDESMBAGA1UE
        AwwJdGVzdF9jZXJ0MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEMmUaVefHDJhO
        LGA/PKqluKpIeKIE0tIz8kEwOhaOM+XRfK1T2Odz3xnp3jqVGeL/P76Ablpyt3Uj
        VXqS/2jq76M1MDMwDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMB
        MAwGA1UdEwEB/wQCMAAwCgYIKoZIzj0EAwIDSQAwRgIhAK+7rWkrAf4aXxq58ZPy
        175Lb3nuEfT/4Tn8EK+FFg6CAiEA2mPRF2557E4Y9pZD2t/rnJckithC1DoynXbo
        4QSlqGs=
        -----END CERTIFICATE-----
      caCertificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBfzCCASagAwIBAgIQMJVWFnFemVqOdrdBfMiEWTAKBggqhkjOPQQDAjAkMRAw
        DgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQDEwdSb290IENBMCAXDTIwMDUwNjExMTEz
        M1oYDzIxMjAwNDEyMTExMTMzWjAkMRAwDgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQD
        EwdSb290IENBMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEozunafHXRgl2QGGC
        3/ja+bvmp2jHUz+7w8spemFyxQtBUavrxohfw0Hj/RmSmsBab8eMjkAoLfupy3o2
        bWQokqM4MDYwDgYDVR0PAQH/BAQDAgIEMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8G
        A1UdEwEB/wQFMAMBAf8wCgYIKoZIzj0EAwIDRwAwRAIgXD6m3SkXRzwTN2SKnYbB
        tTCa9cVkpYedp87IY9j282YCIEhcJ6KCjx+UOqBtPeMCKILaWtWwiUrJJ3eedVov
        VMsw
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-custom-cert-reencrypt
  spec:
    port:
      targetPort: 8443
    tls:
      termination: reencrypt
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEIPN2W4ngtcEGm9Hk9U1ZspuB/6zWAHkZdrr98ol8U4RnoAoGCCqGSM49
        AwEHoUQDQgAEhXmPxAoTowg6uYJ35GlIGRrK4JDvb+beKmiFfmg3/d35UB7RjvpY
        hioCVnpZgnJlRPxfb7AEbrq5vdEDtncNZA==
        -----END EC PRIVATE KEY-----
      certificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBfzCCASWgAwIBAgIQRH2BG0wWEr9woy+8mmUG8jAKBggqhkjOPQQDAjAkMRAw
        DgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQDEwdSb290IENBMCAXDTIwMDUwNjExMTEz
        M1oYDzIxMjAwNDEyMTExMTMzWjAmMRAwDgYDVQQKEwdSZWQgSGF0MRIwEAYDVQQD
        DAl0ZXN0X2NlcnQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAASFeY/EChOjCDq5
        gnfkaUgZGsrgkO9v5t4qaIV+aDf93flQHtGO+liGKgJWelmCcmVE/F9vsARuurm9
        0QO2dw1kozUwMzAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEw
        DAYDVR0TAQH/BAIwADAKBggqhkjOPQQDAgNIADBFAiBAz7KLaPUa5GP0WAyDdPyP
        hfL4e2SkG2x1FZTEIuGwIAIhAJNmK7WvxtMHQAERnRd+yLz21ScieAlvIqcWNbXt
        cb/0
        -----END CERTIFICATE-----
      caCertificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBfzCCASagAwIBAgIQeYuQ9aVfawn5fD9kjKO5TDAKBggqhkjOPQQDAjAkMRAw
        DgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQDEwdSb290IENBMCAXDTIwMDUwNjExMTEz
        M1oYDzIxMjAwNDEyMTExMTMzWjAkMRAwDgYDVQQKEwdSZWQgSGF0MRAwDgYDVQQD
        EwdSb290IENBMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEDG+MXvb6hdKdiJgU
        ycQNC+1aE6VXuooShzVvcr92ajL98X2vq08o+IixQ8XBh8OEl5NKIxOj9u4TRBeG
        AY2Mj6M4MDYwDgYDVR0PAQH/BAQDAgIEMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8G
        A1UdEwEB/wQFMAMBAf8wCgYIKoZIzj0EAwIDRwAwRAIgBEXwEsn76/afwcAS2Ssp
        3sBK/dl7KoBNjdlfW3APoVoCIBg6eH08BrTWYTVaNnodOjd3SwItKxDruMURm7oY
        h1Uw
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    name: http2-custom-cert-passthrough
  spec:
    port:
      targetPort: 8443
    tls:
      termination: passthrough
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: http2
      weight: 100
    wildcardPolicy: None
