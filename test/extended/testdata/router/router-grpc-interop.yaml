apiVersion: template.openshift.io/v1
kind: Template
objects:
- apiVersion: v1
  kind: Service
  metadata:
    name: grpc-interop
    annotations:
      service.beta.openshift.io/serving-cert-secret-name: service-certs
  spec:
    selector:
      app: grpc-interop
    ports:
      - port: 8443
        name: https
        targetPort: 8443
        protocol: TCP
      - port: 1110
        name: h2c
        targetPort: 1110
        protocol: TCP
- apiVersion: v1
  kind: ConfigMap
  labels:
    app: grpc-interop
  metadata:
    name: src-config
  data:
    data.base64: |
      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
      +fn8fP5rn/8fAAD//5WdUIAAPAAA
- apiVersion: v1
  kind: ConfigMap
  metadata:
    annotations:
      service.beta.openshift.io/inject-cabundle: "true"
    labels:
      app: grpc-interop
    name: service-ca
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: grpc-interop
  spec:
    selector:
      matchLabels:
        app: grpc-interop
    replicas: 4
    template:
      metadata:
        name: grpc-interop
        labels:
          app: grpc-interop
      spec:
        containers:
        - image: golang:1.14
          name: server
          command: ["/workdir/grpc-server"]
          env:
          - name: GRPC_GO_LOG_VERBOSITY_LEVEL
            value: "99"
          - name: GRPC_GO_LOG_SEVERITY_LEVEL
            value: "info"
          - name: GODEBUG
            value: http2debug=1
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 3
          ports:
          - containerPort: 8443
            protocol: TCP
          - containerPort: 1110
            protocol: TCP
          - containerPort: 8080
            protocol: TCP
          volumeMounts:
          - name: service-certs
            mountPath: /etc/service-certs
          - name: tmp
            mountPath: /var/run
          - name: workdir
            mountPath: /workdir
          readOnly: true
        - image: golang:1.14
          name: client-shell
          command: ["/bin/bash"]
          args: ["-c", "sleep 100000"]
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 3
          ports:
          - containerPort: 8080
            protocol: TCP
          volumeMounts:
          - name: service-certs
            secret:
              secretName: service-certs
            mountPath: /etc/service-certs
          - name: tmp
            mountPath: /var/run
          - name: workdir
            mountPath: /workdir
          - name: service-ca
            mountPath: /etc/service-ca
        initContainers:
        - image: golang:1.14
          name: builder
          command: ["/bin/bash", "-c"]
          args:
            - set -e;
              cd /workdir;
              base64 -d /go/src/data.base64 | tar zxf -;
              go build -v -mod=readonly -o /workdir/grpc-client client.go;
              go build -v -mod=readonly -o /workdir/grpc-server server.go;
          env:
          - name: GO111MODULE
            value: "auto"
          - name: GOCACHE
            value: "/tmp"
          - name: GOPROXY
            value: "https://goproxy.golang.org,direct"
          volumeMounts:
          - name: src-volume
            mountPath: /go/src
          - name: tmp
            mountPath: /var/run
          - name: workdir
            mountPath: /workdir
        volumes:
        - name: src-volume
          configMap:
            name: src-config
        - name: service-certs
          secret:
            secretName: service-certs
        - name: tmp
          emptyDir: {}
        - name: workdir
          emptyDir: {}
        - configMap:
            items:
            - key: service-ca.crt
              path: service-ca.crt
            name: service-ca
          name: service-ca
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    annotations:
      haproxy.router.openshift.io/enable-h2c: "true"
    labels:
      app: grpc-interop
    name: grpc-interop-edge
  spec:
    port:
      targetPort: 1110
    tls:
      termination: edge
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEILIc8XqIk7IYA4rXr88Vm/h2uor640AdLH1pa8Fny+kOoAoGCCqGSM49
        AwEHoUQDQgAEEwTH3nocuTpgDmVYN2Ep9DqTIyErsPeeY+mVJB/rzLHI+00cTRBf
        pxb9UEx7a+fWhG7/yONFcKEv5ZlIGbFG8w==
        -----END EC PRIVATE KEY-----
      certificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBizCCATGgAwIBAgIQTEs2NjcG/9z0WyA5M0LrWTAKBggqhkjOPQQDAjAoMRQw
        EgYDVQQKEwtDZXJ0IEdlbiBDbzEQMA4GA1UEAxMHUm9vdCBDQTAgFw0yMDA1MTgw
        OTU1MTFaGA8yMTIwMDQyNDA5NTUxMVowLjEZMBcGA1UEChMQQ2VydCBHZW4gQ29t
        cGFueTERMA8GA1UEAxMIdGVzdGNlcnQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNC
        AAQTBMfeehy5OmAOZVg3YSn0OpMjISuw955j6ZUkH+vMscj7TRxNEF+nFv1QTHtr
        59aEbv/I40VwoS/lmUgZsUbzozUwMzAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAww
        CgYIKwYBBQUHAwEwDAYDVR0TAQH/BAIwADAKBggqhkjOPQQDAgNIADBFAiEAxsUz
        yNl/2DJktyy7xDmBeZPybPbyWv4ApnpaaoQoVUMCIFEwJtfwGEO+NN4HAbPKQTOS
        pK6nUhQqHPWhu7t15yec
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: grpc-interop
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    labels:
      app: grpc-interop
    name: grpc-interop-reencrypt
  spec:
    port:
      targetPort: 8443
    tls:
      termination: reencrypt
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEILY+Vji+NywGUmWhjLGf0teANh5t8CVSl7yNCQ/1v05woAoGCCqGSM49
        AwEHoUQDQgAEqHrMdKmzQfVZiBUHX0AI9vdMp5/GGLNc7nOA7xNmsGHUq642Av3x
        k3gJlKJOd3Il6gbP+Dd8jLVaVcPHQY/d0g==
        -----END EC PRIVATE KEY-----
      certificate: |
        -----BEGIN CERTIFICATE-----
        MIIBjDCCATKgAwIBAgIRAJGHhBTYpRl7nsRAVtlKPbAwCgYIKoZIzj0EAwIwKDEU
        MBIGA1UEChMLQ2VydCBHZW4gQ28xEDAOBgNVBAMTB1Jvb3QgQ0EwIBcNMjAwNTE4
        MDk1NTI4WhgPMjEyMDA0MjQwOTU1MjhaMC4xGTAXBgNVBAoTEENlcnQgR2VuIENv
        bXBhbnkxETAPBgNVBAMTCHRlc3RjZXJ0MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcD
        QgAEqHrMdKmzQfVZiBUHX0AI9vdMp5/GGLNc7nOA7xNmsGHUq642Av3xk3gJlKJO
        d3Il6gbP+Dd8jLVaVcPHQY/d0qM1MDMwDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQM
        MAoGCCsGAQUFBwMBMAwGA1UdEwEB/wQCMAAwCgYIKoZIzj0EAwIDSAAwRQIhAKqc
        1sgVy/pkQzVK+qY3wL2jgvMFlNNrCNWT2utyFws7AiAVKaAxGN0cSMpx+sB/HD/X
        vYc0adnWNkSLc62dIXsA7Q==
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: grpc-interop
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    labels:
      app: grpc-interop
    name: grpc-interop-passthrough
  spec:
    port:
      targetPort: 8443
    tls:
      termination: passthrough
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: grpc-interop
      weight: 100
    wildcardPolicy: None
