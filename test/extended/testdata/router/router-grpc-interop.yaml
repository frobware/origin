apiVersion: template.openshift.io/v1
kind: Template
objects:
- apiVersion: v1
  kind: Service
  metadata:
    name: grpc-interop
    annotations:
      service.beta.openshift.io/serving-cert-secret-name: service-certs
  spec:
    selector:
      app: grpc-interop
    ports:
      - port: 8443
        name: https
        targetPort: 8443
        protocol: TCP
      - port: 1110
        name: h2c
        targetPort: 1110
        protocol: TCP
- apiVersion: v1
  kind: ConfigMap
  labels:
    app: grpc-interop
  metadata:
    name: src-config
  data:
    data.base64: |
      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
- apiVersion: v1
  kind: ConfigMap
  metadata:
    annotations:
      service.beta.openshift.io/inject-cabundle: "true"
    labels:
      app: grpc-interop
    name: service-ca
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: grpc-interop
  spec:
    selector:
      matchLabels:
        app: grpc-interop
    replicas: 10
    template:
      metadata:
        name: grpc-interop
        labels:
          app: grpc-interop
      spec:
        containers:
        - image: golang:1.14
          name: server
          command: ["/workdir/grpc-server"]
          env:
          - name: GRPC_GO_LOG_VERBOSITY_LEVEL
            value: "99"
          - name: GRPC_GO_LOG_SEVERITY_LEVEL
            value: "info"
          - name: GODEBUG
            value: http2debug=1
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 3
          ports:
          - containerPort: 8443
            protocol: TCP
          - containerPort: 1110
            protocol: TCP
          - containerPort: 8080
            protocol: TCP
          volumeMounts:
          - name: service-certs
            mountPath: /etc/service-certs
          - name: tmp
            mountPath: /var/run
          - name: workdir
            mountPath: /workdir
          readOnly: true
        - image: golang:1.14
          name: client-shell
          command: ["/bin/bash"]
          args: ["-c", "sleep 100000"]
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 3
          ports:
          - containerPort: 8080
            protocol: TCP
          volumeMounts:
          - name: service-certs
            secret:
              secretName: service-certs
            mountPath: /etc/service-certs
          - name: tmp
            mountPath: /var/run
          - name: workdir
            mountPath: /workdir
          - name: service-ca
            mountPath: /etc/service-ca
        initContainers:
        - image: golang:1.14
          name: builder
          command: ["/bin/bash", "-c"]
          args:
            - set -e;
              cd /workdir;
              base64 -d /go/src/data.base64 | tar zxf -;
              go build -v -mod=readonly -o /workdir/grpc-client client.go;
              go build -v -mod=readonly -o /workdir/grpc-server server.go;
          env:
          - name: GO111MODULE
            value: "auto"
          - name: GOCACHE
            value: "/tmp"
          - name: GOPROXY
            value: "https://goproxy.golang.org,direct"
          volumeMounts:
          - name: src-volume
            mountPath: /go/src
          - name: tmp
            mountPath: /var/run
          - name: workdir
            mountPath: /workdir
        volumes:
        - name: src-volume
          configMap:
            name: src-config
        - name: service-certs
          secret:
            secretName: service-certs
        - name: tmp
          emptyDir: {}
        - name: workdir
          emptyDir: {}
        - configMap:
            items:
            - key: service-ca.crt
              path: service-ca.crt
            name: service-ca
          name: service-ca
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    annotations:
      haproxy.router.openshift.io/enable-h2c: "true"
    labels:
      app: grpc-interop
    name: grpc-interop-edge
  spec:
    port:
      targetPort: 1110
    tls:
      termination: edge
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEILIc8XqIk7IYA4rXr88Vm/h2uor640AdLH1pa8Fny+kOoAoGCCqGSM49
        AwEHoUQDQgAEEwTH3nocuTpgDmVYN2Ep9DqTIyErsPeeY+mVJB/rzLHI+00cTRBf
        pxb9UEx7a+fWhG7/yONFcKEv5ZlIGbFG8w==
        -----END EC PRIVATE KEY-----
      certificate: |-
        -----BEGIN CERTIFICATE-----
        MIIBizCCATGgAwIBAgIQTEs2NjcG/9z0WyA5M0LrWTAKBggqhkjOPQQDAjAoMRQw
        EgYDVQQKEwtDZXJ0IEdlbiBDbzEQMA4GA1UEAxMHUm9vdCBDQTAgFw0yMDA1MTgw
        OTU1MTFaGA8yMTIwMDQyNDA5NTUxMVowLjEZMBcGA1UEChMQQ2VydCBHZW4gQ29t
        cGFueTERMA8GA1UEAxMIdGVzdGNlcnQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNC
        AAQTBMfeehy5OmAOZVg3YSn0OpMjISuw955j6ZUkH+vMscj7TRxNEF+nFv1QTHtr
        59aEbv/I40VwoS/lmUgZsUbzozUwMzAOBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAww
        CgYIKwYBBQUHAwEwDAYDVR0TAQH/BAIwADAKBggqhkjOPQQDAgNIADBFAiEAxsUz
        yNl/2DJktyy7xDmBeZPybPbyWv4ApnpaaoQoVUMCIFEwJtfwGEO+NN4HAbPKQTOS
        pK6nUhQqHPWhu7t15yec
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: grpc-interop
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    labels:
      app: grpc-interop
    name: grpc-interop-reencrypt
  spec:
    port:
      targetPort: 8443
    tls:
      termination: reencrypt
      insecureEdgeTerminationPolicy: Redirect
      key: |-
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEILY+Vji+NywGUmWhjLGf0teANh5t8CVSl7yNCQ/1v05woAoGCCqGSM49
        AwEHoUQDQgAEqHrMdKmzQfVZiBUHX0AI9vdMp5/GGLNc7nOA7xNmsGHUq642Av3x
        k3gJlKJOd3Il6gbP+Dd8jLVaVcPHQY/d0g==
        -----END EC PRIVATE KEY-----
      certificate: |
        -----BEGIN CERTIFICATE-----
        MIIBjDCCATKgAwIBAgIRAJGHhBTYpRl7nsRAVtlKPbAwCgYIKoZIzj0EAwIwKDEU
        MBIGA1UEChMLQ2VydCBHZW4gQ28xEDAOBgNVBAMTB1Jvb3QgQ0EwIBcNMjAwNTE4
        MDk1NTI4WhgPMjEyMDA0MjQwOTU1MjhaMC4xGTAXBgNVBAoTEENlcnQgR2VuIENv
        bXBhbnkxETAPBgNVBAMTCHRlc3RjZXJ0MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcD
        QgAEqHrMdKmzQfVZiBUHX0AI9vdMp5/GGLNc7nOA7xNmsGHUq642Av3xk3gJlKJO
        d3Il6gbP+Dd8jLVaVcPHQY/d0qM1MDMwDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQM
        MAoGCCsGAQUFBwMBMAwGA1UdEwEB/wQCMAAwCgYIKoZIzj0EAwIDSAAwRQIhAKqc
        1sgVy/pkQzVK+qY3wL2jgvMFlNNrCNWT2utyFws7AiAVKaAxGN0cSMpx+sB/HD/X
        vYc0adnWNkSLc62dIXsA7Q==
        -----END CERTIFICATE-----
    to:
      kind: Service
      name: grpc-interop
      weight: 100
    wildcardPolicy: None
- apiVersion: route.openshift.io/v1
  kind: Route
  metadata:
    labels:
      app: grpc-interop
    name: grpc-interop-passthrough
  spec:
    port:
      targetPort: 8443
    tls:
      termination: passthrough
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: grpc-interop
      weight: 100
    wildcardPolicy: None
